<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>å‹æ½”å¯¦-å±…å®¶æ¸…æ½”é ç´„ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* æ·±è‰²ä¸»é¡ŒèƒŒæ™¯ */
        body { background-color: #2f314a; font-family: -apple-system, sans-serif; padding-bottom: 80px; color: #f0f0f0; }
        .card { background-color: #3b3d5c; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-body h5 { color: #fff; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 15px; }
        
        .step-section { display: none; }
        .step-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Nav Tabs & Service Rows */
        .nav-tabs { border-bottom: 1px solid #555; }
        .nav-tabs .nav-link { color: #ccc; }
        .nav-tabs .nav-link.active { background-color: #3b3d5c; color: #ddae4e; border-color: #555 #555 #3b3d5c; font-weight: bold; border-bottom: 2px solid #ddae4e; }
        .service-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #4a4c6e; border-bottom: 1px solid #555; margin-bottom: 5px; border-radius: 5px; }
        .service-row strong { color: #fff; }
        .service-row small { color: #ccc !important; }
        .qty-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddae4e; background: transparent; color: #ddae4e; font-weight: bold; }
        .qty-input { width: 35px; text-align: center; border: none; background: transparent; font-weight: bold; color: #fff; }
        
        /* Calendar */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #4a4c6e; padding: 10px; border-radius: 8px; border: 1px solid #555; }
        .btn-cal-nav { background: #3b3d5c; border: 1px solid #555; border-radius: 5px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; }
        .current-month-label { font-weight: bold; font-size: 1.1rem; color: #ddae4e; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day-header { text-align: center; font-size: 0.8rem; font-weight: bold; color: #ccc; padding-bottom: 5px; }
        
        .cal-cell { 
            background: #4a4c6e; border: 1px solid #555; border-radius: 5px; min-height: 70px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
            padding: 5px 1px; cursor: pointer; position: relative; color: #fff;
        }
        .cal-cell.today { border: 2px solid #ddae4e; }
        .cal-cell.selected { background-color: #ddae4e !important; border-color: #ddae4e; color: #fff; box-shadow: 0 0 10px rgba(221, 174, 78, 0.5); }
        .cal-cell.selected::after { content: 'âœ”'; position: absolute; top: 2px; right: 2px; font-size: 12px; color: #fff; background: rgba(0,0,0,0.3); border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; }
        .cal-cell.disabled { background-color: #2a2c42; color: #555; cursor: not-allowed; border-color: #333; }
        
        .cal-date { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        
        /* â˜… æ–°å¢ï¼šä¾èº«åˆ†åˆ¥å€åˆ†é¡è‰² */
        .cal-badge { font-size: 0.6rem; padding: 1px 2px; border-radius: 3px; width: 96%; text-align: center; line-height: 1.1; margin-bottom: 1px; color: #fff; }
        .badge-a { background-color: #0d6efd; /* Blue for A */ }
        .badge-b { background-color: #198754; /* Green for B */ }
        .badge-c { background-color: #fd7e14; /* Orange for C */ }
        
        .cal-tag-recommend { position: absolute; top: -5px; left: -5px; background: #ff3333; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); z-index: 10; border: 2px solid #fff; animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .slot-btn { width: 100%; margin-bottom: 8px; text-align: left; padding: 10px; border: 1px solid #ddae4e; background: transparent; color: #ddae4e; border-radius: 8px; position: relative; }
        .slot-btn.active { background: #ddae4e; color: white; }
        .rank-badge { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: white; color: #b08d42; width: 20px; height: 20px; border-radius: 50%; text-align: center; font-size: 12px; line-height: 20px; display: none; }
        .slot-btn.active .rank-badge { display: block; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #2f314a; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 1000; border-top: 1px solid #444; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff; }
        
        .form-control, .form-select { background-color: #4a4c6e; border: 1px solid #555; color: #fff; }
        .form-control:focus, .form-select:focus { background-color: #55577a; color: #fff; border-color: #ddae4e; box-shadow: 0 0 0 0.25rem rgba(221, 174, 78, 0.25); }
        .input-group-text { background-color: #3b3d5c; border-color: #555; color: #ccc; }
        .form-control::placeholder { color: #aaa; }
        
        .img-box { float: left; width: 70px; height: 70px; margin: 5px; position: relative; border: 1px solid #555; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 5px; }
        .btn-del-img { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; text-align: center; cursor: pointer; }
        
        #promo-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; }
        #promo-content { position: relative; max-width: 90%; max-height: 90%; }
        #promo-content img { width: 100%; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        
        .bg-light { background-color: #4a4c6e !important; color: #fff; }
        .text-muted { color: #ccc !important; }
        .btn-outline-gold { color: #ddae4e; border-color: #ddae4e; }
        .btn-outline-gold:hover { color: #fff; background-color: #ddae4e; border-color: #ddae4e; }
        .text-gold { color: #ddae4e !important; }
        
        /* åœ–ä¾‹æ¨£å¼ */
        .legend-box { display: flex; gap: 10px; justify-content: center; margin-bottom: 8px; font-size: 0.75rem; color: #ccc; }
        .legend-item { display: flex; align-items: center; gap: 3px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner-border text-gold"></div><div class="mt-2">è™•ç†ä¸­...</div></div>

<div id="promo-overlay">
    <div id="promo-content">
        <img src="https://i.ibb.co/pBsf5s7f/promotion.jpg" alt="å„ªæƒ æ´»å‹•">
    </div>
</div>

<div class="container mt-3">
    <div class="d-flex justify-content-center align-items-center mb-4">
        <img src="SJS_LOGO_ol_05_0.png" alt="Logo" style="height: 50px; margin-right: 12px; border-radius: 5px;">
        <h4 class="fw-bold mb-0" style="color: #ddae4e;">å‹æ½”å¯¦-å±…å®¶æ¸…æ½”</h4>
    </div>

    <div id="step1" class="step-section active">
        <div class="card shadow-sm"><div class="card-body">
            <h5>1. æœå‹™åœ°å€</h5>
            <select id="city-select" class="form-select mb-3" onchange="updateDistricts()">
                <option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>
            </select>
            <select id="district-select" class="form-select" disabled><option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option></select>
            <div id="other-city-alert" class="alert alert-warning mt-3" style="display:none; background-color: #594a28; color: #ffca2c; border: 1px solid #7a6332;">
                <small>âš ï¸ é¸æ“‡å…¶ä»–ç¸£å¸‚å¯èƒ½æœƒç”¢ç”Ÿé¡å¤–è»Šé¦¬è²»ï¼Œè«‹å‹™å¿…å¡«å¯«å®Œæ•´åœ°å€ä»¥ä¾¿è©•ä¼°ã€‚</small>
            </div>
        </div></div>
    </div>

    <div id="step2" class="step-section">
        <div class="card shadow-sm"><div class="card-body p-2">
            <h5>2. æœå‹™é …ç›®</h5>
            <div class="alert alert-secondary small py-2 mb-3" style="background-color: #3b3d5c; color: #ccc; border: 1px solid #555;">
                â„ï¸ åˆ†é›¢å¼å†·æ°£å„ªæƒ ï¼š<br>
                1å° $2000 | 2å° $3000 | 3å° $4500<br>
                4å°ä»¥ä¸Šæ¯åŠ 1å° +$1500
            </div>
            <ul class="nav nav-tabs nav-fill mb-3" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#content-a">A. å†·æ°£/å®¶é›»</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-b">B. å±…å®¶/æ¸…æ½”</button></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="content-a"></div>
                <div class="tab-pane fade" id="content-b"></div>
            </div>
            <div class="alert alert-info mt-3 d-flex justify-content-between align-items-center mb-0" style="background-color: #3d352b; border-color: #ddae4e; color: #ffebb7;">
                <span>é ä¼°ç¸½é¡</span><strong class="fs-4 text-gold">$<span id="total-price">0</span></strong>
            </div>
            <div class="text-end text-muted small mt-1">é ä¼°ç¸½å·¥æ™‚: <span id="total-time">0</span> åˆ†é˜</div>
        </div></div>
    </div>

    <div id="step3" class="step-section">
        <div class="card shadow-sm"><div class="card-body">
            <h5>3. ä¸Šå‚³ç…§ç‰‡ (é¸å¡«)</h5>
            <div class="mb-3"><label class="btn btn-outline-gold w-100">â• é¸æ“‡ç…§ç‰‡<input type="file" accept="image/*" multiple hidden onchange="handleFiles(this.files)"></label></div>
            <div id="preview-area" class="clearfix"></div>
            <p class="text-muted small mt-2">äº‹å‰æä¾›ç…§ç‰‡ï¼Œå¸«å‚…æ‰èƒ½æä¾›æ›´å®Œå–„çš„æœå‹™ã€‚</p>
        </div></div>
    </div>

    <div id="step4" class="step-section">
        <div class="card shadow-sm"><div class="card-body p-2">
            <h5>4. é¸æ“‡é ç´„æ—¥æœŸ</h5>
            <div class="alert alert-warning small py-1" style="background-color: #594a28; color: #ffca2c; border: 1px solid #7a6332;">
                è«‹é¸æ“‡ <b>3 å€‹æ™‚æ®µ</b>ã€‚<br>
                <span class="badge bg-danger rounded-circle">æ¨</span> è¡¨ç¤ºå¸«å‚…ç•¶å¤©å·²åœ¨åŒç¸£å¸‚æœå‹™ã€‚
            </div>
            
            <div class="legend-box">
                <div class="legend-item"><div class="legend-dot" style="background:#0d6efd;"></div>å¸«å‚…A</div>
                <div class="legend-item"><div class="legend-dot" style="background:#198754;"></div>å¸«å‚…B</div>
                <div class="legend-item"><div class="legend-dot" style="background:#fd7e14;"></div>å¸«å‚…C</div>
            </div>

            <div class="calendar-controls">
                <div class="btn-cal-nav" onclick="changeMonth(-1)">&#10094;</div>
                <div class="current-month-label" id="cal-month-label"></div>
                <div class="btn-cal-nav" onclick="changeMonth(1)">&#10095;</div>
            </div>
            <div class="calendar-grid mb-2">
                <div class="cal-day-header text-danger">æ—¥</div><div class="cal-day-header">ä¸€</div><div class="cal-day-header">äºŒ</div><div class="cal-day-header">ä¸‰</div><div class="cal-day-header">å››</div><div class="cal-day-header">äº”</div><div class="cal-day-header text-danger">å…­</div>
            </div>
            <div id="calendar-body" class="calendar-grid">
                <div class="text-center w-100 py-3" style="grid-column: 1 / -1;">è¼‰å…¥è¡Œç¨‹è¡¨...</div>
            </div>
            <div id="time-slot-section" style="display:none;" class="mt-3 border-top pt-3">
                <h6 class="fw-bold">ğŸ“… <span id="selected-date-display"></span> å¯é ç´„æ™‚æ®µ</h6>
                <div id="slots-container" class="row g-2"></div>
            </div>
        </div></div>
    </div>

    <div id="step5" class="step-section">
        <div class="card shadow-sm"><div class="card-body">
            <h5>5. ç¢ºèªè³‡æ–™</h5>
            <input type="text" id="user-name" class="form-control mb-3" placeholder="ç¨±å‘¼">
            <input type="tel" id="user-phone" class="form-control mb-3" placeholder="é›»è©±">
            <div class="input-group mb-3"><span class="input-group-text" id="addr-prefix"></span><input type="text" id="user-addr" class="form-control" placeholder="åœ°å€ (è«‹å¡«å¯«å®Œæ•´)"></div>
            <textarea id="user-remarks" class="form-control mb-3" placeholder="å‚™è¨»éœ€æ±‚ (ä¾‹å¦‚ï¼šå»ºè­°åœè»Šä½ç½®ã€ç¤¾å€ç‰¹æ®Šéœ€æ±‚ã€ç‰¹æ®Šå‹è™Ÿ/æè³ª...)"></textarea>
            
            <div class="bg-light p-3 rounded mb-3"><h6 class="fw-bold">å·²é¸æ™‚æ®µ</h6><ul id="final-slot-list" class="ps-3 mb-0 small"></ul></div>
            <div class="bg-light p-3 rounded">
                <div id="final-item-list" class="small text-muted"></div>
                <div class="text-end fw-bold text-gold mt-1">ç¸½è¨ˆ: $<span id="final-price">0</span></div>
                <div class="text-end small text-warning mt-2" style="font-size: 0.8rem; border-top: 1px dashed #555; padding-top: 5px;">
                    (æ­¤ç‚ºé ä¼°é‡‘é¡ï¼Œè¦–æƒ…æ³ä¾ç•¶å¤©æ–½ä½œç’°å¢ƒã€å…¶ä»–ç¸£å¸‚åŠæ–½ä½œé›£æ˜“åº¦ç‚ºä¸»)
                </div>
            </div>
        </div></div>
    </div>
</div>

<div class="bottom-nav">
    <button id="btn-prev" class="btn btn-secondary w-50" onclick="changeStep(-1)" disabled>ä¸Šä¸€æ­¥</button>
    <button id="btn-next" class="btn btn-primary w-50" onclick="changeStep(1)">ä¸‹ä¸€æ­¥</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ================= è¨­å®šå€ =================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw1df2c6I0iW8mlbIifeUT-VZ7469RpIpuwellN87iy8NrYfBJfZJY7G8ce5W_3D7ye/exec"; 
    const LIFF_ID = "2008804953-Zf22ukHp"; 
    // =========================================

    const CITY_DATA = {
        "å°åŒ—å¸‚": ["ä¸­æ­£å€","å¤§åŒå€","ä¸­å±±å€","æ¾å±±å€","å¤§å®‰å€","è¬è¯å€","ä¿¡ç¾©å€","å£«æ—å€","åŒ—æŠ•å€","å…§æ¹–å€","å—æ¸¯å€","æ–‡å±±å€"],
        "æ–°åŒ—å¸‚": ["æ¿æ©‹å€","ä¸‰é‡å€","ä¸­å’Œå€","æ°¸å’Œå€","æ–°èŠå€","æ–°åº—å€","åœŸåŸå€","è˜†æ´²å€","æ¨¹æ—å€","æ±æ­¢å€","é¶¯æ­Œå€","ä¸‰å³½å€","æ·¡æ°´å€","ç‘èŠ³å€","äº”è‚¡å€","æ³°å±±å€","æ—å£å€","æ·±å‘å€","çŸ³ç¢‡å€","åªæ—å€","ä¸‰èŠå€","çŸ³é–€å€","å…«é‡Œå€","å¹³æºªå€","é›™æºªå€","è²¢å¯®å€","é‡‘å±±å€","è¬é‡Œå€","çƒä¾†å€"],
        "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€","ä¸­å£¢å€","å¤§æºªå€","æ¥Šæ¢…å€","è˜†ç«¹å€","å¤§åœ’å€","é¾œå±±å€","å…«å¾·å€","é¾æ½­å€","å¹³é®å€","æ–°å±‹å€","è§€éŸ³å€","å¾©èˆˆå€"],
        "å…¶ä»–ç¸£å¸‚": []
    };

    const CATALOG = { 
        'A': { 'ac_split':{n:'åˆ†é›¢å¼å†·æ°£',t:60,p:2000}, 'ac_window':{n:'çª—å‹å†·æ°£',t:120,p:3500}, 'ac_hidden':{n:'åŠéš±å¼å†·æ°£',t:120,p:3000}, 'ac_4way':{n:'å››æ–¹å¹å†·æ°£',t:150,p:4500}, 'wash_top':{n:'ç›´ç«‹æ´—',t:90,p:1500}, 'wash_drum':{n:'æ»¾ç­’æ´—',t:180,p:3500} },
        'B': { 'bath':{n:'æµ´å®¤éè†œ(é–“)',t:210,p:4500}, 'bed_1':{n:'æ´—åºŠ(å–®äºº)',t:180,p:1500}, 'bed_2':{n:'æ´—åºŠ(é›™äºº)',t:180,p:2500}, 'sofa_1':{n:'æ´—æ²™ç™¼(å–®äºº)',t:120,p:1500}, 'sofa_2':{n:'æ´—æ²™ç™¼(é›™äºº)',t:120,p:2000}, 'sofa_all':{n:'æ´—æ²™ç™¼(å…¨çµ„)',t:120,p:3500}, 'mite_home':{n:'å±…å®¶é™¤å¡µèŸ(é–“)',t:60,p:2000}, 'mite_sofa_1':{n:'é™¤èŸ-æ²™ç™¼(å–®)',t:60,p:600}, 'mite_sofa_2':{n:'é™¤èŸ-æ²™ç™¼(é›™)',t:60,p:1000}, 'mite_sofa_l':{n:'é™¤èŸ-æ²™ç™¼(Lå‹)',t:60,p:1500}, 'mite_bed_1':{n:'é™¤èŸ-åºŠ(å–®)',t:60,p:600}, 'mite_bed_2':{n:'é™¤èŸ-åºŠ(é›™)',t:60,p:1200} }
    };

    let currentStep = 1;
    let order = { items:{}, totalPrice:0, totalTime:0, images:[], slots:[], tempTimeA:0, tempTimeB:0 };
    let userProfile = null;
    let viewDate = new Date(); 
    let hasShownPromo = false; 
    let currentBusyMap = {}; 

    window.onload = async () => {
        initCitySelect();
        renderMenu('A','content-a'); renderMenu('B','content-b');
        try { 
            await liff.init({liffId:LIFF_ID}); 
            if(liff.isLoggedIn()){ 
                userProfile=await liff.getProfile(); 
                document.getElementById('user-name').value=userProfile.displayName; 
            } else liff.login(); 
        } catch(e){ console.log("LIFF Error:", e); }
        loadMonthSchedule(); 
    };

    function initCitySelect() {
        const citySelect = document.getElementById('city-select');
        for (const city in CITY_DATA) {
            citySelect.add(new Option(city, city));
        }
    }

    function updateDistricts(){ 
        const c=document.getElementById('city-select').value, d=document.getElementById('district-select'); 
        d.innerHTML='<option value="">è«‹é¸å€åŸŸ</option>'; d.disabled=false;
        const alertBox = document.getElementById('other-city-alert');
        if(c==='å…¶ä»–ç¸£å¸‚'){ 
            d.innerHTML='<option value="ç„¡">ç„¡</option>'; 
            alertBox.style.display = 'block'; 
            Swal.fire({ icon: 'warning', title: 'æ³¨æ„', text: 'æ‚¨é¸æ“‡äº†å…¶ä»–ç¸£å¸‚ï¼Œå¯èƒ½æœƒæœ‰é¡å¤–çš„è»Šé¦¬è²»ï¼Œå¸«å‚…å°‡èˆ‡æ‚¨è¯ç¹«å ±åƒ¹ã€‚' });
        } else {
            alertBox.style.display = 'none'; 
            if(CITY_DATA[c]) CITY_DATA[c].forEach(x=>d.add(new Option(x,x)));
        }
        updateAddrPrefix();
    }
    
    function updateAddrPrefix(){ 
        const c=document.getElementById('city-select').value;
        const d=document.getElementById('district-select').value; 
        if(c&&d) {
            let displayDistrict = (d === 'ç„¡') ? '' : d;
            document.getElementById('addr-prefix').innerText = c + displayDistrict; 
        }
    }

    function renderMenu(type,id){
        let h=''; 
        for(let k in CATALOG[type]){
            let i=CATALOG[type][k];
            h+=`<div class="service-row"><div><strong>${i.n}</strong><br><small class="text-muted">$${i.p}</small></div><div class="qty-control"><button class="qty-btn" onclick="chQty('${k}','${type}',-1)">-</button><input id="qty-${k}" class="qty-input" value="0" readonly><button class="qty-btn" onclick="chQty('${k}','${type}',1)">+</button></div></div>`;
        }
        document.getElementById(id).innerHTML=h;
    }
    
    function chQty(k,type,d){
        let el=document.getElementById(`qty-${k}`), v=parseInt(el.value)+d;
        if(v<0)v=0; el.value=v; order.items[k]=v;
        let p=0, timeA=0, timeB=0;
        let splitAcCount = order.items['ac_split'] || 0;
        let splitAcPrice = 0;
        if (splitAcCount === 1) splitAcPrice = 2000;
        else if (splitAcCount >= 2) splitAcPrice = splitAcCount * 1500; 

        for(let key in order.items){
            let qty = order.items[key];
            if(qty>0){
                if (key === 'ac_split') {
                    p += splitAcPrice;
                    timeA += CATALOG.A[key].t * qty;
                } else {
                    if(CATALOG.A[key]){ p+=CATALOG.A[key].p*qty; timeA+=CATALOG.A[key].t*qty; }
                    else if(CATALOG.B[key]){ p+=CATALOG.B[key].p*qty; timeB+=CATALOG.B[key].t*qty; }
                }
            }
        }
        order.totalPrice=p;
        order.totalTime = Math.max(timeA, timeB); 
        document.getElementById('total-price').innerText=p;
        document.getElementById('total-time').innerText=order.totalTime;

        let totalCount = 0;
        for (let key in order.items) {
            totalCount += (order.items[key] || 0); 
        }

        if (totalCount >= 5 && d > 0) { 
             Swal.fire({ toast: true, position: 'top', icon: 'info', title: 'ä»¶æ•¸è¼ƒå¤šæé†’', text: 'å»ºè­°æ‚¨ç›´æ¥èˆ‡å¸«å‚…è¯çµ¡ï¼Œæˆ–ç¹¼çºŒé ç´„ç”±å¸«å‚…ç‚ºæ‚¨å®‰æ’ã€‚', timer: 3000, showConfirmButton: false });
        }
    }

    function handleFiles(fs){ 
        if(order.images.length+fs.length>10)return Swal.fire('æœ€å¤š10å¼µ');
        Array.from(fs).forEach(f=>{
            let r=new FileReader(); r.readAsDataURL(f);
            r.onload=e=>{
                let img=new Image(); img.src=e.target.result;
                img.onload=()=>{
                    let c=document.createElement('canvas'), ctx=c.getContext('2d'), s=800/img.width;
                    c.width=800; c.height=img.height*s; ctx.drawImage(img,0,0,c.width,c.height);
                    order.images.push(c.toDataURL('image/jpeg',0.7));
                    let d=document.createElement('div'); d.className='img-box'; d.innerHTML=`<img src="${order.images[order.images.length-1]}"><div class="btn-del-img" onclick="this.parentNode.remove()">Ã—</div>`;
                    document.getElementById('preview-area').appendChild(d);
                }
            }
        });
    }

    function changeMonth(delta) { viewDate.setMonth(viewDate.getMonth() + delta); loadMonthSchedule(); }
    
    function loadMonthSchedule() {
        let year = viewDate.getFullYear(), month = viewDate.getMonth();
        document.getElementById('cal-month-label').innerText = `${year}å¹´ ${month+1}æœˆ`;
        document.getElementById('calendar-body').innerHTML = '<div class="text-center w-100 py-3" style="grid-column: 1/-1"><div class="spinner-border text-gold"></div></div>';
        fetch(GAS_URL, {method:'POST', body:JSON.stringify({
            action:'getBusySchedule', 
            year: year, 
            month: month,
            items: order.items 
        })})
        .then(r=>r.json()).then(res=>{ 
            currentBusyMap = res; 
            renderCalendarGrid(year, month, res); 
        })
        .catch(e=>document.getElementById('calendar-body').innerHTML='<div class="text-danger p-3" style="grid-column:1/-1">è¼‰å…¥å¤±æ•—</div>');
    }

    // â˜… ä¿®æ”¹ï¼šæ¸²æŸ“æ—¥æ›† (æ”¯æ´ A,B,C é¡è‰²é¡¯ç¤º)
    function renderCalendarGrid(year, month, busyMap){
        let html = '', firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        let today = new Date(); today.setHours(0,0,0,0);
        
        let userCity = document.getElementById('city-select').value; 

        for(let i=0; i<firstDay; i++){ html += `<div class="cal-cell" style="background:#2a2c42;cursor:default;"></div>`; }
        
        for(let i=1; i<=daysInMonth; i++){
            let d = new Date(year, month, i);
            let dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
            
            // å¾Œç«¯å›å‚³æ ¼å¼: { regions: [{name: "æ–°åŒ—å¸‚æ³°å±±å€", type: "A"}, ...], hasSlot: true/false }
            let data = busyMap[dateStr] || { regions: [], hasSlot: true }; 
            let regions = data.regions;
            let hasSlot = data.hasSlot;

            // â˜… ä¿®æ”¹ï¼šBadge é¡¯ç¤ºèˆ‡é¡è‰²
            // region æ˜¯ç‰©ä»¶ {name, type}
            let badgeHtml = regions.map(r => {
                let badgeClass = '';
                if (r.type === 'A') badgeClass = 'badge-a';
                else if (r.type === 'B') badgeClass = 'badge-b';
                else if (r.type === 'C') badgeClass = 'badge-c';
                
                // æ–·è¡Œè™•ç† (æ–°åŒ—å¸‚<br>æ³°å±±å€)
                let displayName = r.name.replace(/(..[ç¸£å¸‚])/, '$1<br>');
                
                return `<div class="cal-badge ${badgeClass}">${displayName}</div>`;
            }).join('');
            
            // æ¨è–¦é‚è¼¯
            let recommendTag = '';
            if (d >= today && regions.length > 0 && hasSlot && userCity && userCity !== 'å…¶ä»–ç¸£å¸‚') {
                // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä¸€è¡Œç¨‹é–‹é ­ç¬¦åˆä½¿ç”¨è€…ç¸£å¸‚
                let isMatch = regions.some(r => r.name.startsWith(userCity));
                if (isMatch) {
                    recommendTag = `<div class="cal-tag-recommend">æ¨</div>`;
                }
            }

            if (d < today) {
                html += `<div class="cal-cell disabled"><div class="cal-date">${i}</div>${badgeHtml}</div>`;
            } else if (!hasSlot) {
                html += `<div class="cal-cell disabled" style="background:#3b2a2a; border-color:#5a3333;">
                            <div class="cal-date text-danger">${i}</div>
                            <div style="font-size:10px; color:#ff6b6b; font-weight:bold;">å·²æ»¿</div>
                         </div>`;
            } else {
                html += `<div class="cal-cell" onclick="selectDate('${dateStr}', this)">
                            ${recommendTag}
                            <div class="cal-date">${i}</div>
                            ${badgeHtml}
                         </div>`;
            }
        }
        document.getElementById('calendar-body').innerHTML = html;
    }

    function selectDate(dateStr, el){
        document.querySelectorAll('.cal-cell').forEach(c=>c.classList.remove('selected')); el.classList.add('selected');
        document.getElementById('time-slot-section').style.display='block';
        document.getElementById('selected-date-display').innerText = dateStr;
        document.getElementById('slots-container').innerHTML='<div class="text-center w-100 py-3"><div class="spinner-border text-gold"></div></div>';
        fetch(GAS_URL, {method:'POST', body:JSON.stringify({action:'getSlots', date:dateStr, items:order.items})})
        .then(r=>r.json()).then(res=>{
            let h='';
            if(res.slots.length===0) h='<div class="alert alert-danger w-100" style="background-color: #5a3333; border-color: #8a4444; color: #ffcccc;">æœ¬æ—¥é ç´„å·²æ»¿</div>';
            else res.slots.forEach(s=>{
                let active = order.slots.some(x=>x.date===dateStr && x.time===s.time) ? 'active' : '';
                let rank = active ? order.slots.findIndex(x=>x.date===dateStr && x.time===s.time)+1 : '';
                h+=`<div class="col-6"><button class="slot-btn ${active}" onclick="toggleSlot('${dateStr}','${s.time}',this)">${s.label}<span class="rank-badge">${rank}</span></button></div>`;
            });
            document.getElementById('slots-container').innerHTML = h;
            // é€™è£¡å¾Œç«¯å›å‚³ timeA, timeB, timeCï¼Œå‰ç«¯æš«æ™‚åªéœ€å­˜èµ·ä¾†ä¾›åƒè€ƒï¼Œå¯¦éš›è¨ˆç®—ç”±å¾Œç«¯è™•ç†
        });
    }

    function toggleSlot(d, t, btn){
        let idx = order.slots.findIndex(s=>s.date===d && s.time===t);
        if(idx!==-1){ 
            order.slots.splice(idx,1); 
            btn.classList.remove('active'); 
            btn.querySelector('.rank-badge').style.display='none'; 
        } else {
            if(order.slots.length>=3) return Swal.fire('æœ€å¤š3å€‹æ™‚æ®µ');
            
            let isRec = false;
            let userCity = document.getElementById('city-select').value;
            // â˜… ä¿®æ”¹ï¼šæª¢æŸ¥ regions çµæ§‹ (ç¾åœ¨æ˜¯ç‰©ä»¶é™£åˆ—)
            if (currentBusyMap && currentBusyMap[d] && currentBusyMap[d].regions && userCity && userCity !== 'å…¶ä»–ç¸£å¸‚') {
                if (currentBusyMap[d].regions.some(r => r.name.startsWith(userCity))) {
                    isRec = true;
                }
            }

            order.slots.push({date:d, time:t, isRec: isRec}); 
            
            btn.classList.add('active'); 
            btn.querySelector('.rank-badge').innerText = order.slots.length; 
            btn.querySelector('.rank-badge').style.display='block';
            
            let currentCount = order.slots.length;
            if(currentCount < 3) {
                 Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `å·²é¸ç¬¬ ${currentCount} é †ä½`, text: `è«‹ç¹¼çºŒé¸æ“‡ç¬¬ ${currentCount + 1} é †ä½`, showConfirmButton: false, timer: 1500 });
            } else {
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '3å€‹æ™‚æ®µé¸æ“‡å®Œç•¢ï¼', text: 'è«‹é»æ“Šä¸‹ä¸€æ­¥ç¢ºèªè³‡æ–™', showConfirmButton: false, timer: 2000 });
            }
        }
    }

    function changeStep(d){
        if(d===1){
            if(currentStep===1 && !document.getElementById('district-select').value) return Swal.fire('è«‹é¸åœ°å€');
            
            if(currentStep===1 && !hasShownPromo) {
                document.getElementById('promo-overlay').style.display = 'flex';
                hasShownPromo = true;
                setTimeout(() => { document.getElementById('promo-overlay').style.display = 'none'; }, 3000);
            }

            if(currentStep===2 && order.totalPrice===0) return Swal.fire('è«‹é¸æœå‹™');
            
            if(currentStep===4){
                if(order.slots.length !== 3) return Swal.fire('è«‹é¸æ“‡ 3 å€‹æ™‚æ®µ', 'ç‚ºäº†æ–¹ä¾¿å®‰æ’ï¼Œè«‹å‹™å¿…é¸æ“‡ 3 å€‹å¿—é¡˜åºæ™‚æ®µæ‰èƒ½ç¹¼çºŒå–”ï¼', 'warning');
                updateAddrPrefix(); 
                document.getElementById('final-item-list').innerText = Object.keys(order.items).filter(k=>order.items[k]>0).map(k=>(CATALOG.A[k]||CATALOG.B[k]).n+'x'+order.items[k]).join(', ');
                document.getElementById('final-price').innerText = order.totalPrice;
                document.getElementById('final-slot-list').innerHTML = order.slots.map((s,i)=>`<li>é †ä½${i+1}: ${s.date} ${s.time}</li>`).join('');
            }
            if(currentStep===5 && d===1) { submitOrder(); return; }
        }
        currentStep+=d;
        document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active'));
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('btn-prev').disabled=(currentStep===1);
        document.getElementById('btn-next').innerText=(currentStep===5)?'ç¢ºèªé ç´„':'ä¸‹ä¸€æ­¥';
        if(currentStep===4) loadMonthSchedule();
        window.scrollTo(0,0);
    }

    function submitOrder(){
        let n=document.getElementById('user-name').value, p=document.getElementById('user-phone').value, a=document.getElementById('user-addr').value;
        let city = document.getElementById('city-select').value;
        let remarks = document.getElementById('user-remarks').value; 

        if(city === 'å…¶ä»–ç¸£å¸‚' && a.length < 5) return Swal.fire('è«‹å¡«å¯«å®Œæ•´åœ°å€', 'é¸æ“‡å…¶ä»–ç¸£å¸‚æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è©³ç´°åœ°å€ä»¥ä¾¿æˆ‘å€‘è©•ä¼°è»Šé¦¬è²»ã€‚', 'warning');
        
        if(!n||!p||!a) return Swal.fire('è«‹å¡«å®Œæ•´è³‡æ–™');
        
        document.getElementById('loading-overlay').style.display='flex';
        fetch(GAS_URL, {
            method:'POST',
            body:JSON.stringify({
                action:'submitOrder', 
                userId: userProfile ? userProfile.userId : 'Guest',
                name:n, phone:p, city:city, district:document.getElementById('district-select').value, address:a,
                items:order.items, summary:document.getElementById('final-item-list').innerText, totalPrice:order.totalPrice,
                selectedSlots:order.slots, images:order.images, timeA:order.tempTimeA, timeB:order.tempTimeB,
                remarks: remarks 
            })
        })
        .then(r=>r.json()).then(res=>{
            document.getElementById('loading-overlay').style.display='none';
            if(res.status==='success') Swal.fire('æˆåŠŸ','å·²æ”¶åˆ°æ‚¨çš„é ç´„è«‹æ±‚ï¼Œå¸«å‚…æœƒç›¡å¿«å”åŠ©ç¢ºèªï¼Œè«‹ç•™æ„æ‚¨çš„LINEé€šçŸ¥','success').then(()=>liff.closeWindow());
            else Swal.fire('å¤±æ•—',res.msg,'error');
        })
        .catch(e=>{ 
            document.getElementById('loading-overlay').style.display='none'; 
            console.error(e);
            Swal.fire('éŒ¯èª¤', 'ç³»çµ±é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦: ' + e.toString(), 'error'); 
        });
    }
</script>
</body>
</html>

