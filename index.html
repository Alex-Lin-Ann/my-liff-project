<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>å‹æ½”å¯¦-å±…å®¶æ¸…æ½”é ç´„ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, sans-serif; padding-bottom: 80px; }
        .step-section { display: none; }
        .step-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-bottom: 3px solid #0d6efd; }
        .service-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-bottom: 1px solid #eee; }
        .qty-control { display: flex; align-items: center; }
        .qty-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; background: white; color: #0d6efd; font-weight: bold; }
        .qty-input { width: 35px; text-align: center; border: none; background: transparent; font-weight: bold; }
        
        /* å»£å‘Šå½ˆçª—æ¨£å¼ */
        #promo-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; display: none;
            justify-content: center; align-items: center;
        }
        #promo-content { position: relative; max-width: 90%; max-height: 90%; }
        #promo-content img { width: 100%; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6; }
        .btn-cal-nav { background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #333; }
        .current-month-label { font-weight: bold; font-size: 1.1rem; color: #0d6efd; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day-header { text-align: center; font-size: 0.8rem; font-weight: bold; color: #666; padding-bottom: 5px; }
        .cal-cell { 
            background: #fff; border: 1px solid #dee2e6; border-radius: 5px; min-height: 65px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
            padding: 5px 1px; cursor: pointer; position: relative;
        }
        .cal-cell.today { border: 2px solid #0d6efd; }
        .cal-cell.selected { background-color: #0d6efd !important; border-color: #0d47a1; color: white; box-shadow: 0 0 5px rgba(13, 110, 253, 0.5); }
        .cal-cell.selected::after { content: 'âœ”'; position: absolute; top: 2px; right: 2px; font-size: 12px; color: white; background: rgba(0,0,0,0.2); border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; }
        .cal-cell.disabled { background-color: #f2f2f2; color: #ccc; cursor: not-allowed; border-color: #eee; }
        .cal-date { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .cal-badge { font-size: 0.65rem; padding: 2px 1px; border-radius: 3px; width: 98%; text-align: center; line-height: 1.1; word-break: break-all; }
        .cal-badge.region { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        .img-box { float: left; width: 70px; height: 70px; margin: 5px; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 5px; }
        .btn-del-img { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; text-align: center; cursor: pointer; }
        
        .slot-btn { width: 100%; margin-bottom: 8px; text-align: left; padding: 10px; border: 1px solid #0d6efd; background: white; color: #0d6efd; border-radius: 8px; position: relative; }
        .slot-btn.active { background: #0d6efd; color: white; }
        .rank-badge { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: white; color: #0d6efd; width: 20px; height: 20px; border-radius: 50%; text-align: center; font-size: 12px; line-height: 20px; display: none; }
        .slot-btn.active .rank-badge { display: block; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner-border text-primary"></div><div class="mt-2">è™•ç†ä¸­...</div></div>

<div id="promo-overlay">
    <div id="promo-content">
        <img src="https://drive.google.com/drive/folders/159QxQ1DIdQ5QOrIyrvjEGLnDX1GTP-kN?dmr=1&ec=wgc-drive-hero-goto" alt="2026å¹´å„ªæƒ æ´»å‹•">
    </div>
</div>

<div class="container mt-3">
    <h4 class="text-center mb-4 text-primary fw-bold">å‹æ½”å¯¦-å±…å®¶æ¸…æ½”</h4>

    <div id="step1" class="step-section active">
        <div class="card shadow-sm border-0"><div class="card-body">
            <h5>1. æœå‹™åœ°å€</h5>
            <select id="city-select" class="form-select mb-3" onchange="updateDistricts()">
                <option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>
            </select>
            <select id="district-select" class="form-select" disabled><option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option></select>
            <div id="other-city-alert" class="alert alert-warning mt-3" style="display:none;">
                <small>âš ï¸ é¸æ“‡å…¶ä»–ç¸£å¸‚å¯èƒ½æœƒç”¢ç”Ÿé¡å¤–è»Šé¦¬è²»ï¼Œè«‹å‹™å¿…å¡«å¯«å®Œæ•´åœ°å€ä»¥ä¾¿è©•ä¼°ã€‚</small>
            </div>
        </div></div>
    </div>

    <div id="step2" class="step-section">
        <div class="card shadow-sm border-0"><div class="card-body p-2">
            <h5>2. æœå‹™é …ç›®</h5>
            <div class="alert alert-secondary small py-2 mb-3">
                â„ï¸ åˆ†é›¢å¼å†·æ°£å„ªæƒ ï¼š<br>
                1å° $2000 | 2å° $3000 | 3å° $4500<br>
                4å°ä»¥ä¸Šæ¯åŠ 1å° +$1500
            </div>
            <ul class="nav nav-tabs nav-fill mb-3" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#content-a">A. å†·æ°£/å®¶é›»</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-b">B. å±…å®¶/æ¸…æ½”</button></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="content-a"></div>
                <div class="tab-pane fade" id="content-b"></div>
            </div>
            <div class="alert alert-info mt-3 d-flex justify-content-between align-items-center mb-0">
                <span>é ä¼°ç¸½é¡</span><strong class="fs-4 text-danger">$<span id="total-price">0</span></strong>
            </div>
            <div class="text-end text-muted small mt-1">é ä¼°ç¸½å·¥æ™‚: <span id="total-time">0</span> åˆ†é˜</div>
        </div></div>
    </div>

    <div id="step3" class="step-section">
        <div class="card shadow-sm border-0"><div class="card-body">
            <h5>3. ä¸Šå‚³ç…§ç‰‡ (é¸å¡«)</h5>
            <div class="mb-3"><label class="btn btn-outline-primary w-100">â• é¸æ“‡ç…§ç‰‡<input type="file" accept="image/*" multiple hidden onchange="handleFiles(this.files)"></label></div>
            <div id="preview-area" class="clearfix"></div>
            <p class="text-muted small mt-2">ç…§ç‰‡å°‡é€éé€£çµé™„åœ¨é€šçŸ¥ä¿¡ä¸­ã€‚</p>
        </div></div>
    </div>

    <div id="step4" class="step-section">
        <div class="card shadow-sm border-0"><div class="card-body p-2">
            <h5>4. é¸æ“‡é ç´„æ—¥æœŸ</h5>
            <div class="alert alert-warning small py-1">
                è«‹é¸æ“‡ <b>3 å€‹æ™‚æ®µ</b>ã€‚<br>
                <b>é–‹æ”¾æ™‚é–“ï¼š</b>å¹³æ—¥ 09:00~14:30 | å‡æ—¥ 09:00~19:00
            </div>
            <div class="calendar-controls">
                <div class="btn-cal-nav" onclick="changeMonth(-1)">&#10094;</div>
                <div class="current-month-label" id="cal-month-label"></div>
                <div class="btn-cal-nav" onclick="changeMonth(1)">&#10095;</div>
            </div>
            <div class="calendar-grid mb-2">
                <div class="cal-day-header text-danger">æ—¥</div><div class="cal-day-header">ä¸€</div><div class="cal-day-header">äºŒ</div><div class="cal-day-header">ä¸‰</div><div class="cal-day-header">å››</div><div class="cal-day-header">äº”</div><div class="cal-day-header text-danger">å…­</div>
            </div>
            <div id="calendar-body" class="calendar-grid">
                <div class="text-center w-100 py-3" style="grid-column: 1 / -1;">è¼‰å…¥è¡Œç¨‹è¡¨...</div>
            </div>
            <div id="time-slot-section" style="display:none;" class="mt-3 border-top pt-3">
                <h6 class="fw-bold">ğŸ“… <span id="selected-date-display"></span> å¯é ç´„æ™‚æ®µ</h6>
                <div id="slots-container" class="row g-2"></div>
            </div>
        </div></div>
    </div>

    <div id="step5" class="step-section">
        <div class="card shadow-sm border-0"><div class="card-body">
            <h5>5. ç¢ºèªè³‡æ–™</h5>
            <input type="text" id="user-name" class="form-control mb-3" placeholder="ç¨±å‘¼">
            <input type="tel" id="user-phone" class="form-control mb-3" placeholder="é›»è©±">
            <div class="input-group mb-3"><span class="input-group-text bg-light" id="addr-prefix"></span><input type="text" id="user-addr" class="form-control" placeholder="åœ°å€ (è«‹å¡«å¯«å®Œæ•´)"></div>
            <textarea id="user-remarks" class="form-control mb-3" placeholder="å‚™è¨»éœ€æ±‚ (ä¾‹å¦‚ï¼šæœ‰é¤Šå¯µç‰©ã€è‡ªå‚™åœè»Šä½...)"></textarea>
            
            <div class="bg-light p-3 rounded mb-3"><h6 class="fw-bold">å·²é¸æ™‚æ®µ</h6><ul id="final-slot-list" class="ps-3 mb-0 small"></ul></div>
            <div class="bg-light p-3 rounded"><div id="final-item-list" class="small text-muted"></div><div class="text-end fw-bold text-danger mt-1">ç¸½è¨ˆ: $<span id="final-price">0</span></div></div>
        </div></div>
    </div>
</div>

<div class="bottom-nav">
    <button id="btn-prev" class="btn btn-secondary w-50" onclick="changeStep(-1)" disabled>ä¸Šä¸€æ­¥</button>
    <button id="btn-next" class="btn btn-primary w-50" onclick="changeStep(1)">ä¸‹ä¸€æ­¥</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ================= è¨­å®šå€ =================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxbbqpETuIoK5v2a9eTwtGlWczs-BpqRUVBd8PKX2vtwfT0QhvPkZf6_f7dLAYBVFgiMg/exec"; 
    const LIFF_ID = "2008787455-1meqQHRA"; 
    // =========================================

    const CITY_DATA = {
        "å°åŒ—å¸‚": ["ä¸­æ­£å€","å¤§åŒå€","ä¸­å±±å€","æ¾å±±å€","å¤§å®‰å€","è¬è¯å€","ä¿¡ç¾©å€","å£«æ—å€","åŒ—æŠ•å€","å…§æ¹–å€","å—æ¸¯å€","æ–‡å±±å€"],
        "æ–°åŒ—å¸‚": ["æ¿æ©‹å€","ä¸‰é‡å€","ä¸­å’Œå€","æ°¸å’Œå€","æ–°èŠå€","æ–°åº—å€","åœŸåŸå€","è˜†æ´²å€","æ¨¹æ—å€","æ±æ­¢å€","é¶¯æ­Œå€","ä¸‰å³½å€","æ·¡æ°´å€","ç‘èŠ³å€","äº”è‚¡å€","æ³°å±±å€","æ—å£å€","æ·±å‘å€","çŸ³ç¢‡å€","åªæ—å€","ä¸‰èŠå€","çŸ³é–€å€","å…«é‡Œå€","å¹³æºªå€","é›™æºªå€","è²¢å¯®å€","é‡‘å±±å€","è¬é‡Œå€","çƒä¾†å€"],
        "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€","ä¸­å£¢å€","å¤§æºªå€","æ¥Šæ¢…å€","è˜†ç«¹å€","å¤§åœ’å€","é¾œå±±å€","å…«å¾·å€","é¾æ½­å€","å¹³é®å€","æ–°å±‹å€","è§€éŸ³å€","å¾©èˆˆå€"],
        "å…¶ä»–ç¸£å¸‚": []
    };

    // â˜… æ›´æ–°ï¼šåƒ¹ç›®è¡¨ (å°æ‡‰æ‚¨æä¾›çš„æ–°åƒ¹æ ¼)
    const CATALOG = { 
        'A': { 
            'ac_split':{n:'åˆ†é›¢å¼å†·æ°£',t:60,p:2000}, // åŸºç¤åƒ¹2000, ç¨‹å¼æœƒè‡ªå‹•ç®—å„ªæƒ 
            'ac_window':{n:'çª—å‹å†·æ°£',t:120,p:3500}, 
            'ac_hidden':{n:'åŠéš±å¼å†·æ°£',t:120,p:3000}, // å–å€é–“ä½æ¨™
            'ac_4way':{n:'å››æ–¹å¹å†·æ°£',t:150,p:4500},
            'wash_top':{n:'ç›´ç«‹æ´—è¡£æ©Ÿ',t:90,p:1500}, 
            'wash_drum':{n:'æ»¾ç­’æ´—è¡£æ©Ÿ',t:180,p:3500} 
        },
        'B': { 
            'bath':{n:'æµ´å®¤éè†œ(é–“)',t:210,p:4500},
            'bed_1':{n:'æ´—åºŠ(å–®äºº)',t:180,p:1500},
            'bed_2':{n:'æ´—åºŠ(é›™äºº)',t:180,p:2500},
            'sofa_1':{n:'æ´—æ²™ç™¼(å–®äºº)',t:120,p:1500}, 
            'sofa_2':{n:'æ´—æ²™ç™¼(é›™äºº)',t:120,p:2000}, 
            'sofa_all':{n:'æ´—æ²™ç™¼(å…¨çµ„)',t:120,p:3500},
            'mite_home':{n:'å±…å®¶é™¤å¡µèŸ(é–“)',t:60,p:2000},
            'mite_sofa_1':{n:'é™¤èŸ-æ²™ç™¼(å–®)',t:60,p:600},
            'mite_sofa_2':{n:'é™¤èŸ-æ²™ç™¼(é›™)',t:60,p:1000},
            'mite_sofa_l':{n:'é™¤èŸ-æ²™ç™¼(Lå‹)',t:60,p:1500},
            'mite_bed_1':{n:'é™¤èŸ-åºŠ(å–®)',t:60,p:600},
            'mite_bed_2':{n:'é™¤èŸ-åºŠ(é›™)',t:60,p:1200}
        }
    };

    let currentStep = 1;
    let order = { items:{}, totalPrice:0, totalTime:0, images:[], slots:[], tempTimeA:0, tempTimeB:0 };
    let userProfile = null;
    let viewDate = new Date(); 
    let hasShownPromo = false; // æ§åˆ¶å»£å‘Šåªé¡¯ç¤ºä¸€æ¬¡

    window.onload = async () => {
        initCitySelect();
        renderMenu('A','content-a'); renderMenu('B','content-b');
        try { 
            await liff.init({liffId:LIFF_ID}); 
            if(liff.isLoggedIn()){ 
                userProfile=await liff.getProfile(); 
                document.getElementById('user-name').value=userProfile.displayName; 
            } else liff.login(); 
        } catch(e){ console.log("LIFF Error:", e); }
        loadMonthSchedule(); 
    };

    function initCitySelect() {
        const citySelect = document.getElementById('city-select');
        for (const city in CITY_DATA) {
            citySelect.add(new Option(city, city));
        }
    }

    function updateDistricts(){ 
        const c=document.getElementById('city-select').value, d=document.getElementById('district-select'); 
        d.innerHTML='<option value="">è«‹é¸å€åŸŸ</option>'; d.disabled=false;
        
        const alertBox = document.getElementById('other-city-alert');
        if(c==='å…¶ä»–ç¸£å¸‚'){ 
            d.innerHTML='<option value="ç„¡">ç„¡</option>'; 
            alertBox.style.display = 'block'; 
            Swal.fire({ icon: 'warning', title: 'æ³¨æ„', text: 'æ‚¨é¸æ“‡äº†å…¶ä»–ç¸£å¸‚ï¼Œå¯èƒ½æœƒæœ‰é¡å¤–çš„è»Šé¦¬è²»ï¼Œå°ˆäººå°‡èˆ‡æ‚¨è¯ç¹«å ±åƒ¹ã€‚' });
        } else {
            alertBox.style.display = 'none'; 
            if(CITY_DATA[c]) CITY_DATA[c].forEach(x=>d.add(new Option(x,x)));
        }
        updateAddrPrefix();
    }
    
    function updateAddrPrefix(){ 
        const c=document.getElementById('city-select').value;
        const d=document.getElementById('district-select').value; 
        if(c&&d) {
            let displayDistrict = (d === 'ç„¡') ? '' : d;
            document.getElementById('addr-prefix').innerText = c + displayDistrict; 
        }
    }

    function renderMenu(type,id){
        let h=''; 
        for(let k in CATALOG[type]){
            let i=CATALOG[type][k];
            h+=`<div class="service-row"><div><strong>${i.n}</strong><br><small class="text-muted">$${i.p}</small></div><div class="qty-control"><button class="qty-btn" onclick="chQty('${k}','${type}',-1)">-</button><input id="qty-${k}" class="qty-input" value="0" readonly><button class="qty-btn" onclick="chQty('${k}','${type}',1)">+</button></div></div>`;
        }
        document.getElementById(id).innerHTML=h;
    }
    
    // â˜… ä¿®æ”¹ï¼šå‹•æ…‹å®šåƒ¹é‚è¼¯ (åˆ†é›¢å¼å†·æ°£) & å¤§é‡é ç´„æé†’
    function chQty(k,type,d){
        let el=document.getElementById(`qty-${k}`), v=parseInt(el.value)+d;
        if(v<0)v=0; el.value=v; order.items[k]=v;
        
        // 1. è¨ˆç®—ç¸½åƒ¹
        let p=0, timeA=0, timeB=0;
        
        // ç‰¹æ®Šè¨ˆç®—: åˆ†é›¢å¼å†·æ°£
        let splitAcCount = order.items['ac_split'] || 0;
        let splitAcPrice = 0;
        if (splitAcCount === 1) splitAcPrice = 2000;
        else if (splitAcCount >= 2) splitAcPrice = splitAcCount * 1500; // 2å°3000(1500*2), 3å°4500(1500*3)... ç¬¦åˆæ¯åŠ ä¸€å°+1500é‚è¼¯

        // éæ­·æ‰€æœ‰é …ç›®
        for(let key in order.items){
            let qty = order.items[key];
            if(qty>0){
                if (key === 'ac_split') {
                    p += splitAcPrice;
                    timeA += CATALOG.A[key].t * qty;
                } else {
                    if(CATALOG.A[key]){ p+=CATALOG.A[key].p*qty; timeA+=CATALOG.A[key].t*qty; }
                    else if(CATALOG.B[key]){ p+=CATALOG.B[key].p*qty; timeB+=CATALOG.B[key].t*qty; }
                }
            }
        }
        order.totalPrice=p;
        order.totalTime = Math.max(timeA, timeB); 
        document.getElementById('total-price').innerText=p;
        document.getElementById('total-time').innerText=order.totalTime;

        // 2. æª¢æŸ¥æ˜¯å¦éœ€è¦æé†’ (å†·æ°£+æ´—è¡£æ©Ÿ >= 5)
        let acCount = (order.items['ac_split']||0) + (order.items['ac_window']||0) + (order.items['ac_hidden']||0) + (order.items['ac_4way']||0);
        let washCount = (order.items['wash_top']||0) + (order.items['wash_drum']||0);
        if (acCount + washCount >= 5 && d > 0) { // åªåœ¨å¢åŠ æ•¸é‡æ™‚è·³æé†’
             Swal.fire({
                toast: true,
                position: 'top',
                icon: 'info',
                title: 'å°æ•¸è¼ƒå¤šæé†’',
                text: 'å»ºè­°æ‚¨ç›´æ¥èˆ‡å¸«å‚…è¯çµ¡ï¼Œæˆ–ç¹¼çºŒé ç´„ç”±å°ˆäººç‚ºæ‚¨å®‰æ’ã€‚',
                timer: 3000,
                showConfirmButton: false
            });
        }
    }

    function handleFiles(fs){ 
        if(order.images.length+fs.length>10)return Swal.fire('æœ€å¤š10å¼µ');
        Array.from(fs).forEach(f=>{
            let r=new FileReader(); r.readAsDataURL(f);
            r.onload=e=>{
                let img=new Image(); img.src=e.target.result;
                img.onload=()=>{
                    let c=document.createElement('canvas'), ctx=c.getContext('2d'), s=800/img.width;
                    c.width=800; c.height=img.height*s; ctx.drawImage(img,0,0,c.width,c.height);
                    order.images.push(c.toDataURL('image/jpeg',0.7));
                    let d=document.createElement('div'); d.className='img-box'; d.innerHTML=`<img src="${order.images[order.images.length-1]}"><div class="btn-del-img" onclick="this.parentNode.remove()">Ã—</div>`;
                    document.getElementById('preview-area').appendChild(d);
                }
            }
        });
    }

    function changeMonth(delta) { viewDate.setMonth(viewDate.getMonth() + delta); loadMonthSchedule(); }
    function loadMonthSchedule() {
        let year = viewDate.getFullYear(), month = viewDate.getMonth();
        document.getElementById('cal-month-label').innerText = `${year}å¹´ ${month+1}æœˆ`;
        document.getElementById('calendar-body').innerHTML = '<div class="text-center w-100 py-3" style="grid-column: 1/-1"><div class="spinner-border text-primary"></div></div>';
        fetch(GAS_URL, {method:'POST', body:JSON.stringify({action:'getBusySchedule', year: year, month: month})})
        .then(r=>r.json()).then(res=>{ renderCalendarGrid(year, month, res); })
        .catch(e=>document.getElementById('calendar-body').innerHTML='<div class="text-danger p-3" style="grid-column:1/-1">è¼‰å…¥å¤±æ•—</div>');
    }

    function renderCalendarGrid(year, month, busyMap){
        let html = '', firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        let today = new Date(); today.setHours(0,0,0,0);
        for(let i=0; i<firstDay; i++){ html += `<div class="cal-cell" style="background:#f9f9f9;cursor:default;"></div>`; }
        for(let i=1; i<=daysInMonth; i++){
            let d = new Date(year, month, i);
            let dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
            let regions = busyMap[dateStr] || [];
            let badgeHtml = regions.map(r => `<div class="cal-badge region">${r.replace(' ', '<br>')}</div>`).join('');
            if (d < today) {
                html += `<div class="cal-cell disabled"><div class="cal-date">${i}</div>${badgeHtml}</div>`;
            } else {
                html += `<div class="cal-cell" onclick="selectDate('${dateStr}', this)"><div class="cal-date">${i}</div>${badgeHtml}</div>`;
            }
        }
        document.getElementById('calendar-body').innerHTML = html;
    }

    function selectDate(dateStr, el){
        document.querySelectorAll('.cal-cell').forEach(c=>c.classList.remove('selected')); el.classList.add('selected');
        document.getElementById('time-slot-section').style.display='block';
        document.getElementById('selected-date-display').innerText = dateStr;
        document.getElementById('slots-container').innerHTML='<div class="text-center w-100 py-3"><div class="spinner-border text-primary"></div></div>';
        fetch(GAS_URL, {method:'POST', body:JSON.stringify({action:'getSlots', date:dateStr, items:order.items})})
        .then(r=>r.json()).then(res=>{
            let h='';
            if(res.slots.length===0) h='<div class="alert alert-danger w-100">æœ¬æ—¥é ç´„å·²æ»¿</div>';
            else res.slots.forEach(s=>{
                let active = order.slots.some(x=>x.date===dateStr && x.time===s.time) ? 'active' : '';
                let rank = active ? order.slots.findIndex(x=>x.date===dateStr && x.time===s.time)+1 : '';
                h+=`<div class="col-6"><button class="slot-btn ${active}" onclick="toggleSlot('${dateStr}','${s.time}',this)">${s.label}<span class="rank-badge">${rank}</span></button></div>`;
            });
            document.getElementById('slots-container').innerHTML = h;
            order.tempTimeA = res.timeA; order.tempTimeB = res.timeB; 
        });
    }

    function toggleSlot(d, t, btn){
        let idx = order.slots.findIndex(s=>s.date===d && s.time===t);
        if(idx!==-1){ 
            order.slots.splice(idx,1); 
            btn.classList.remove('active'); 
            btn.querySelector('.rank-badge').style.display='none'; 
        } else {
            if(order.slots.length>=3) return Swal.fire('æœ€å¤š3å€‹æ™‚æ®µ');
            order.slots.push({date:d, time:t});
            btn.classList.add('active'); 
            btn.querySelector('.rank-badge').innerText = order.slots.length; 
            btn.querySelector('.rank-badge').style.display='block';
            
            let currentCount = order.slots.length;
            if(currentCount < 3) {
                 Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `å·²é¸ç¬¬ ${currentCount} é †ä½`, text: `è«‹ç¹¼çºŒé¸æ“‡ç¬¬ ${currentCount + 1} é †ä½`, showConfirmButton: false, timer: 1500 });
            } else {
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '3å€‹æ™‚æ®µé¸æ“‡å®Œç•¢ï¼', text: 'è«‹é»æ“Šä¸‹ä¸€æ­¥ç¢ºèªè³‡æ–™', showConfirmButton: false, timer: 2000 });
            }
        }
    }

    function changeStep(d){
        if(d===1){
            if(currentStep===1 && !document.getElementById('district-select').value) return Swal.fire('è«‹é¸åœ°å€');
            
            // â˜… æ–°å¢ï¼šStep 1 -> Step 2 é¡¯ç¤ºå»£å‘Šå½ˆçª—
            if(currentStep===1 && !hasShownPromo) {
                document.getElementById('promo-overlay').style.display = 'flex';
                hasShownPromo = true;
                setTimeout(() => { document.getElementById('promo-overlay').style.display = 'none'; }, 3000);
            }

            if(currentStep===2 && order.totalPrice===0) return Swal.fire('è«‹é¸æœå‹™');
            
            // â˜… æ–°å¢ï¼šå¼·åˆ¶æª¢æŸ¥ 3 å€‹æ™‚æ®µ
            if(currentStep===4){
                if(order.slots.length !== 3) return Swal.fire('è«‹é¸æ“‡ 3 å€‹æ™‚æ®µ', 'ç‚ºäº†æ–¹ä¾¿å®‰æ’ï¼Œè«‹å‹™å¿…é¸æ“‡ 3 å€‹å¿—é¡˜åºæ™‚æ®µæ‰èƒ½ç¹¼çºŒå–”ï¼', 'warning');
                updateAddrPrefix(); 
                document.getElementById('final-item-list').innerText = Object.keys(order.items).filter(k=>order.items[k]>0).map(k=>(CATALOG.A[k]||CATALOG.B[k]).n+'x'+order.items[k]).join(', ');
                document.getElementById('final-price').innerText = order.totalPrice;
                document.getElementById('final-slot-list').innerHTML = order.slots.map((s,i)=>`<li>é †ä½${i+1}: ${s.date} ${s.time}</li>`).join('');
            }
            if(currentStep===5 && d===1) { submitOrder(); return; }
        }
        currentStep+=d;
        document.querySelectorAll('.step-section').forEach(e=>e.classList.remove('active'));
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('btn-prev').disabled=(currentStep===1);
        document.getElementById('btn-next').innerText=(currentStep===5)?'ç¢ºèªé ç´„':'ä¸‹ä¸€æ­¥';
        if(currentStep===4) loadMonthSchedule();
        window.scrollTo(0,0);
    }

    function submitOrder(){
        let n=document.getElementById('user-name').value, p=document.getElementById('user-phone').value, a=document.getElementById('user-addr').value;
        let city = document.getElementById('city-select').value;
        let remarks = document.getElementById('user-remarks').value; // â˜… å–å¾—å‚™è¨»

        if(city === 'å…¶ä»–ç¸£å¸‚' && a.length < 5) return Swal.fire('è«‹å¡«å¯«å®Œæ•´åœ°å€', 'é¸æ“‡å…¶ä»–ç¸£å¸‚æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è©³ç´°åœ°å€ä»¥ä¾¿æˆ‘å€‘è©•ä¼°è»Šé¦¬è²»ã€‚', 'warning');
        
        if(!n||!p||!a) return Swal.fire('è«‹å¡«å®Œæ•´è³‡æ–™');
        
        document.getElementById('loading-overlay').style.display='flex';
        fetch(GAS_URL, {
            method:'POST',
            body:JSON.stringify({
                action:'submitOrder', 
                userId: userProfile ? userProfile.userId : 'Guest',
                name:n, phone:p, city:city, district:document.getElementById('district-select').value, address:a,
                items:order.items, summary:document.getElementById('final-item-list').innerText, totalPrice:order.totalPrice,
                selectedSlots:order.slots, images:order.images, timeA:order.tempTimeA, timeB:order.tempTimeB,
                remarks: remarks // â˜… å‚³é€å‚™è¨»
            })
        })
        .then(r=>r.json()).then(res=>{
            document.getElementById('loading-overlay').style.display='none';
            if(res.status==='success') Swal.fire('æˆåŠŸ','å·²é€šçŸ¥å¸«å‚…ï¼Œè«‹ç•™æ„LINEé€šçŸ¥','success').then(()=>liff.closeWindow());
            else Swal.fire('å¤±æ•—',res.msg,'error');
        })
        .catch(e=>{ document.getElementById('loading-overlay').style.display='none'; Swal.fire('éŒ¯èª¤',e.toString(),'error'); });
    }
</script>
</body>
</html>

