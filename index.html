<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>預約清潔服務</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background-color: #f8f9fa; padding-bottom: 80px; }
    .step { display: none; }
    .step.active { display: block; }
    .slot-btn { width: 100%; margin-bottom: 10px; text-align: left; position: relative; }
    .slot-btn.active { background-color: #198754; color: white; border-color: #198754; }
    .rank-badge { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: white; color: #198754; width: 20px; height: 20px; border-radius: 50%; text-align: center; font-size: 12px; line-height: 20px; font-weight: bold; display: none; }
    .slot-btn.active .rank-badge { display: block; }
    .img-preview { width: 60px; height: 60px; object-fit: cover; margin: 5px; border-radius: 5px; border: 1px solid #ddd; }
  </style>
</head>
<body>

<div class="container mt-3">
  <h4 class="text-center mb-4">預約清潔服務</h4>

  <div id="step1" class="step active">
    <h5>1. 選擇地區</h5>
    <select id="city" class="form-select mb-3" onchange="updateDistricts()">
      <option value="" disabled selected>縣市</option>
      <option value="台北市">台北市</option>
      <option value="新北市">新北市</option>
      <option value="桃園市">桃園市</option>
      <option value="其他縣市">其他縣市</option>
    </select>
    <select id="district" class="form-select mb-3" disabled><option>區域</option></select>
    <button class="btn btn-primary w-100" onclick="nextStep(2)">下一步</button>
  </div>

  <div id="step2" class="step">
    <h5>2. 選擇項目</h5>
    <div id="menuList"></div>
    <div class="text-end fw-bold text-danger my-3">總計: $<span id="totalPrice">0</span></div>
    <button class="btn btn-secondary w-100 mb-2" onclick="nextStep(1)">上一步</button>
    <button class="btn btn-primary w-100" onclick="nextStep(3)">下一步</button>
  </div>

  <div id="step3" class="step">
    <h5>3. 上傳照片 (選填)</h5>
    <input type="file" id="fileInput" class="form-control mb-2" accept="image/*" multiple onchange="handleFiles(this.files)">
    <div id="previewBox"></div>
    <button class="btn btn-secondary w-100 mb-2" onclick="nextStep(2)">上一步</button>
    <button class="btn btn-primary w-100" onclick="nextStep(4)">下一步</button>
  </div>

  <div id="step4" class="step">
    <h5>4. 選擇時間 (最多3個)</h5>
    <input type="date" id="datePicker" class="form-control mb-3" onchange="loadSlots()">
    <div id="busyHint" class="mb-2 text-muted small"></div>
    <div id="slotBox" class="row g-2"></div>
    <button class="btn btn-secondary w-100 mt-3 mb-2" onclick="nextStep(3)">上一步</button>
    <button class="btn btn-primary w-100" onclick="nextStep(5)" id="btnStep5" disabled>下一步</button>
  </div>

  <div id="step5" class="step">
    <h5>5. 確認資料</h5>
    <input type="text" id="userName" class="form-control mb-2" placeholder="稱呼">
    <input type="tel" id="userPhone" class="form-control mb-2" placeholder="電話">
    <input type="text" id="userAddr" class="form-control mb-3" placeholder="詳細地址">
    <div class="alert alert-secondary small">
        <strong>已選時段：</strong><ul id="finalSlots" class="mb-0 ps-3"></ul>
    </div>
    <button class="btn btn-secondary w-100 mb-2" onclick="nextStep(4)">上一步</button>
    <button class="btn btn-success w-100" onclick="submitOrder()">送出預約</button>
  </div>
</div>

<script>
  // ================= 設定區 =================
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzSOjtg9Y5FXPEjKzgmyIFctllRHMlLTuEdOXJV4HcLFbMaOiM7HMcNVYDJtrt-u_CX/exec"; 
  const LIFF_ID = "2008741256-7dO5Dfxz";
  // =========================================

  const CITY_DATA = { "台北市":["大安區","信義區","士林區"], "新北市":["板橋區","新莊區"], "桃園市":["桃園區","中壢區"], "其他縣市":[] }; // 簡化範例，請自行補全
  const CATALOG = { 'A':{'ac':{n:'冷氣',p:2000}}, 'B':{'sofa':{n:'沙發',p:1000}} }; // 簡化範例，請自行補全
  let order = { items:{}, totalPrice:0, slots:[], images:[] };
  let profile = null;

  window.onload = async () => {
    // 渲染選單 (這裡用簡化版，請複製之前的完整版)
    document.getElementById('menuList').innerHTML = '<p>請在此貼上完整的 renderList 程式碼</p>';
    
    await liff.init({ liffId: LIFF_ID });
    if (liff.isLoggedIn()) {
      profile = await liff.getProfile();
      document.getElementById('userName').value = profile.displayName;
    } else { liff.login(); }
  };

  function updateDistricts() {
    let city = document.getElementById('city').value;
    let dist = document.getElementById('district');
    dist.innerHTML = '<option>區域</option>';
    dist.disabled = false;
    if(CITY_DATA[city]) CITY_DATA[city].forEach(d => dist.add(new Option(d,d)));
  }

  function handleFiles(files) {
    if(order.images.length + files.length > 5) return alert('最多5張');
    Array.from(files).forEach(f => {
      let reader = new FileReader();
      reader.readAsDataURL(f);
      reader.onload = e => {
        // 壓縮
        let img = new Image(); img.src = e.target.result;
        img.onload = () => {
          let cvs = document.createElement('canvas');
          let scale = 800/img.width;
          cvs.width = 800; cvs.height = img.height*scale;
          cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
          let base64 = cvs.toDataURL('image/jpeg', 0.6);
          order.images.push(base64);
          document.getElementById('previewBox').innerHTML += `<img src="${base64}" class="img-preview">`;
        }
      }
    });
  }

  function loadSlots() {
    let d = document.getElementById('datePicker').value;
    if(!d) return;
    document.getElementById('slotBox').innerHTML = '載入中...';
    // 呼叫 GAS (請複製之前的完整 loadSlots 邏輯)
    google.script.run.withSuccessHandler(res => {
        let html = '';
        res.slots.forEach(s => {
            html += `<div class="col-6"><button class="btn btn-outline-success slot-btn" onclick="toggleSlot('${d}','${s.time}',this)">${s.label}<span class="rank-badge"></span></button></div>`;
        });
        document.getElementById('slotBox').innerHTML = html;
        // 恢復已選狀態
        order.slots.forEach((sel, i) => {
            if(sel.date === d) {
                // 這裡需要較複雜的 DOM 查找，簡化版省略
            }
        });
    }).getAvailableSlots(d, order.items);
  }

  function toggleSlot(date, time, btn) {
    // 切換邏輯 (同前版)
    let idx = order.slots.findIndex(s => s.date==date && s.time==time);
    if(idx >= 0) { order.slots.splice(idx, 1); btn.classList.remove('active'); }
    else {
        if(order.slots.length >= 3) return alert('最多3個');
        order.slots.push({date, time});
        btn.classList.add('active');
    }
    document.getElementById('btnStep5').disabled = order.slots.length === 0;
  }

  function nextStep(step) {
    document.querySelectorAll('.step').forEach(e=>e.classList.remove('active'));
    document.getElementById('step'+step).classList.add('active');
    if(step===5) {
        document.getElementById('finalSlots').innerHTML = order.slots.map((s,i)=>`<li>順位${i+1}: ${s.date} ${s.time}</li>`).join('');
    }
  }

  function submitOrder() {
    let payload = {
        userId: profile ? profile.userId : 'Guest',
        name: document.getElementById('userName').value,
        phone: document.getElementById('userPhone').value,
        city: document.getElementById('city').value,
        district: document.getElementById('district').value,
        address: document.getElementById('userAddr').value,
        items: order.items,
        summary: '項目略', // 請補全
        totalPrice: order.totalPrice, // 請補全
        selectedSlots: order.slots,
        images: order.images,
        timeA: 0, timeB: 0 // 需從 loadSlots 取得
    };
    
    Swal.showLoading();
    google.script.run.withSuccessHandler(res => {
        if(res.status === 'success') Swal.fire('成功','已送出','success').then(()=>liff.closeWindow());
        else Swal.fire('失敗', res.msg, 'error');
    }).submitOrder(payload);
  }
</script>
</body>
</html>
